stages:
  - dynamodb
  - init
  - validate
  - plan
  - apply
  - destroy

image:
  name: hashicorp/terraform:1.10
  entrypoint: [""]

variables:
  AWS_DEFAULT_REGION: "us-east-1"

# Only run pipeline on staging-related branches
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"  # Only run for staging
    - when: never  # Don't run on other branches

before_script:
  - export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
  - export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}

statelock:
  stage: dynamodb
  image: 
    name: amazon/aws-cli:latest
    entrypoint: [""]
  script:
    - |
      TABLE_EXISTS=$(aws dynamodb describe-table --table-name ng-java-app-terraform-lock --region us-east-1 2>&1 || echo "not found")
      if [[ "$TABLE_EXISTS" == *"not found"* ]]; then
        echo "Creating DynamoDB table ng-java-app-terraform-lock..."
        aws dynamodb create-table \
          --table-name ng-java-app-terraform-lock \
          --attribute-definitions AttributeName=LockID,AttributeType=S \
          --key-schema AttributeName=LockID,KeyType=HASH \
          --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
          --region us-east-1
      else
        echo "Table already exists, skipping creation."
      fi
      
init:
  stage: init
  script:
    - terraform init 
  artifacts:
    paths:
      - .terraform/
      - .terraform.lock.hcl

validate:
  stage: validate
  dependencies:
    - init
  script:
    - terraform fmt -check -recursive
    - terraform validate

plan:
  stage: plan
  dependencies:
    - init
  script:
    - terraform init
    - terraform plan -var-file=staging.tfvars -out=planfile
    - terraform show -no-color planfile > planfile.txt
  artifacts:
    paths:
      - planfile
      - planfile.txt
    reports:
      terraform: planfile

apply:
  stage: apply
  dependencies:
    - plan
  script:
    - terraform init
    - terraform apply -input=false planfile
    - terraform output > output.txt
  artifacts:
    paths:
      - output.txt
  when: manual

destroy:
  stage: destroy
  dependencies:
    - init
  script:
    - terraform init
    - terraform destroy -var-file=staging.tfvars --auto-approve | tee destroy-output.txt
  artifacts:
    paths:
      - destroy-output.txt
    expire_in: 7 days
  when: manual